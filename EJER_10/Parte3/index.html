<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Acceso a Búnker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .valid-feedback, .invalid-feedback {
            display: block;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="mb-4">Validador de Acceso a Búnker</h1>
    <form id="formulario">
        <div class="mb-3">
            <label for="codigo" class="form-label">Código de Agente</label>
            <input type="text" class="form-control" id="codigo" required>
            <div id="codigoFeedback" class="form-text"></div>
        </div>
        <div class="mb-3">
            <label for="clave" class="form-label">Clave de Acceso</label>
            <input type="password" class="form-control" id="clave" disabled required>
            <div id="claveFeedback" class="form-text"></div>
        </div>
        <button type="submit" class="btn btn-primary" id="acceder" disabled>Acceder</button>
    </form>
</div>

<script>
let agenteValido = null;
let claveValida = false;

const codigoInput = document.getElementById('codigo');
const claveInput = document.getElementById('clave');
const codigoFeedback = document.getElementById('codigoFeedback');
const claveFeedback = document.getElementById('claveFeedback');
const botonAcceder = document.getElementById('acceder');

codigoInput.addEventListener('blur', () => {
    const codigo = codigoInput.value.trim();
    if (!codigo) return resetCodigo();

    fetch('personal.xml')
        .then(response => {
            if (!response.ok) throw new Error('No se pudo cargar el archivo XML');
            return response.text();
        })
        .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
            const agente = xml.querySelector(`agente[codigo="${codigo}"]`);
            if (agente) {
                agenteValido = agente;
                codigoFeedback.textContent = `Bienvenido, ${agente.querySelector('nombre').textContent}`;
                codigoFeedback.classList.remove('text-danger');
                codigoFeedback.classList.add('text-success');
                claveInput.disabled = false;
                claveInput.value = '';
                claveFeedback.textContent = '';
                claveValida = false;
                botonAcceder.disabled = true;
            } else {
                resetCodigo();
                codigoFeedback.textContent = 'Código de agente no reconocido';
                codigoFeedback.classList.remove('text-success');
                codigoFeedback.classList.add('text-danger');
            }
        })
        .catch(err => {
            codigoFeedback.textContent = 'Error cargando el archivo XML';
            codigoFeedback.classList.add('text-danger');
            resetCodigo();
        });
});

claveInput.addEventListener('blur', () => {
    if (!agenteValido) return;
    const clave = claveInput.value.trim();
    const claveCorrecta = agenteValido.querySelector('clave').textContent;
    if (clave === claveCorrecta) {
        claveFeedback.textContent = 'Clave correcta';
        claveFeedback.classList.remove('text-danger');
        claveFeedback.classList.add('text-success');
        claveValida = true;
        botonAcceder.disabled = false;
    } else {
        claveFeedback.textContent = 'Clave incorrecta';
        claveFeedback.classList.remove('text-success');
        claveFeedback.classList.add('text-danger');
        claveValida = false;
        botonAcceder.disabled = true;
    }
});

codigoInput.addEventListener('input', () => {
    agenteValido = null;
    claveValida = false;
    claveInput.value = '';
    claveInput.disabled = true;
    botonAcceder.disabled = true;
    claveFeedback.textContent = '';
    codigoFeedback.textContent = '';
});

function resetCodigo() {
    agenteValido = null;
    claveValida = false;
    claveInput.value = '';
    claveInput.disabled = true;
    botonAcceder.disabled = true;
}

document.getElementById('formulario').addEventListener('submit', e => {
    e.preventDefault();
    if (agenteValido && claveValida) {
        alert(`Acceso concedido a ${agenteValido.querySelector('nombre').textContent}`);
    }
});
</script>

</body>
</html>
